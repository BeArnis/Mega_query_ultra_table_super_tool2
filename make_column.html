<!DOCTYPE HTML>
<html>
    <head>
    <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge'>
        <title></title>
        <meta name='description' content=''>
        <meta name='viewport' content='width=device-width, initial-scale=1'>

        <script src='bower_components/jquery/jquery.min.js' type='text/javascript'></script>
        <script src='bower_components/jquery-migrate/jquery-migrate.js' type='text/javascript'></script>  <!-- needed for slick grid, because uses features removed from jquery 1.9 -->
        <script src='bower_components/underscore/underscore.js' type='text/javascript'></script>
        <script src='bower_components/stardog/js/stardog.js' type='text/javascript'></script>
        <script src='bower_components/d3/d3.js' type='text/javascript'></script>
        <script src='bower_components/vega/vega.js' type='text/javascript'></script>

        <!-- bootstrap -->
        <link rel='stylesheet' href='bower_components/bootstrap/dist/css/bootstrap.min.css' type='text/css'/>
        <script src='bower_components/bootstrap/dist/js/bootstrap.min.js'></script>
        

        <!-- SlickGrid -->
        <script src='bower_components/slickgrid/lib/jquery.event.drag-2.0.min.js'></script>
        <script src='bower_components/slickgrid/slick.core.js'></script>
        <script src='bower_components/slickgrid/slick.grid.js'></script>
        <script src="bower_components/slickgrid/plugins/slick.rowselectionmodel.js"></script>


        <link rel='stylesheet' href='bower_components/slickgrid/slick.grid.css' type='text/css'/>
        <link rel='stylesheet' href='bower_components/slickgrid/css/smoothness/jquery-ui-1.8.16.custom.css' type='text/css'/>
        <link rel='stylesheet' href='bower_components/slickgrid/examples/examples.css' type='text/css'/>


        <script src="./lib/firebugx.js"></script>

        <script src="./lib/jquery-1.7.min.js"></script>
        <script src="./lib/jquery-ui-1.8.16.custom.min.js"></script>
        <script src="./lib/jquery.event.drag-2.2.js"></script>


        <script src="./TableView.js"></script>
        <script src="./BarChartView.js"></script>

        <script src="./slick.core.js"></script>
        <script src="./slick.formatters.js"></script>
        <script src="./slick.grid.js"></script>

        <script src="./plugins/slick.checkboxselectcolumn.js"></script>
        <script src="./plugins/slick.autotooltips.js"></script>
        <script src="./plugins/slick.cellrangedecorator.js"></script>
        <script src="./plugins/slick.cellrangeselector.js"></script>
        <script src="./plugins/slick.cellcopymanager.js"></script>
        <script src="./plugins/slick.cellselectionmodel.js"></script>
        <script src="./plugins/slick.rowselectionmodel.js"></script>
        <script src="./controls/slick.columnpicker.js"></script>

        <style>
        .delete-button { 
                background: url('close_button.png') no-repeat; 
                width: 30px; 
                height: 30px; 
            }

        .delete-button:hover { 
            background-position: 0 -30px; 
        }
        </style>
        <script src="./slick.editors.js"></script>
    </head>

    <body>
<!-- Large modal -->

<div class="row">
  <div class="col-lg-6">
    <div class="input-group">
      <input class="form-control">
      <div class="input-group-btn">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
        <ul class="dropdown-menu pull-right">
          <li><a href="#">Action</a></li>
          <li><a href="#">Another action</a></li>
          <li><a href="#">Something else here</a></li>
          <li><a href="#">Separated link</a></li>
        </ul>
      </div><!-- /btn-group -->
    </div><!-- /input-group -->
  </div><!-- /.col-lg-6 -->
</div><!-- /.row -->
<button class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg">Large modal</button>



<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
        <ul class="nav nav-tabs" id='MyTab'>
          <li class="active"><a href="#tab" data-toggle="tab">Table</a></li>
          <li><a href="#bar" data-toggle="tab">BarChart</a></li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
        
          <div class="tab-pane active" id="table">
            <!-- Tab -->
          <!-- Table content -->
          
          </div>
          <div class="tab-pane" id="bar">
          <!-- barchart content -->
          bar
          </div>
        </div>
    </div>
  </div>
</div>

    <script type='text/javascript'>
    example_graph = {
            
                't1': {
                    'name': 't1',
                    'query_var_name': 't1',
                    'type' : 'node',
                    'incoming_lines': ['l1'],
                    'query_param': {
                        'input': null,
                        'selection': [{ value: 'http://example.com/ontology1#wife', type: 'uri' }]
                    },
                    'geometry' : {
                        'x' : 150,
                        'y' : 125,
                        'width' : 1010,
                        'height' : 500
                    },
                    'active_visualization_type' : 'TableView', // must be one of keys in visualization_defs
                    'visualization_defs' : {
                        'TableView' : {

                        },
                        'BarChartView' : {
                            'properties': {
                                'y_axis_column' : '??'
                            }
                        }
                    },
                    'columns' : [
                        {
                            // data property
                            'id' : '86ee15e2-2415-4b01-93f9-1fd9b8656d6f',
                            'type' : 'direct',
                            'column_label' : 'label1',
                            'property_name' : 'rdfs:label',
                            'sort': 'none' 
                        },
                        {
                            // data property
                            'id' : 'aeac50f1-7173-4330-80d3-2afb0f991726',
                            'type' : 'direct',
                            'column_label' : 'label2',
                            'property_name' : '<http://example.com/ontology1#wife>',
                            'sort': 'asc'
                        },
                        {
                            // data property
                            'id' : 'e8727bc7-1279-4fb0-897a-84c6f73abce8',
                            'type' : 'aggregate',
                            'column_label' : 'count_l1',
                            'aggregation_function': 'count',
                            'what_to_aggregate': 'l1', // incoming line [], node
                            'sort' : 'desc'
                        }
                    ]
                }
    }


    var body = d3.select('body');

    var width = 600;
    var height = 400;



    
    var container = body.select('#table');

    //bind

    // create container for columns
    var tab_container = container.append('div')
        .classed('input-group', true)
        .style('height', 300 + 'px')
        .style('width', '100%');


    function render_columns(graph, node) { 
        var column_rows = tab_container.selectAll('.column_row')
            .data(node.columns, function(column) {
               
                return column.id;
            });

       

        //create rows
        column_rows
        // .each( function(column) { }
            .enter()
                .append('div') // div collums
                    .classed('column_row', true)
                    .classed('row', true)
                    .style('height', 60 + 'px')
                    .style('width', '100%')
                .each( function(column) { 
                    row = d3.select(this); // each column seperate

                    
                    var main_container = row.append('div')
                        .classed('col-lg-10', true)
                        .classed('main_container', true);


                    var button_container = row.append('div')
                        .classed('col-lg-2', true)
                        .classed('del_cea_container', true);


                    //create delete button
                    button_container
                        .append('div')
                            .classed('delete-button', true)
                            .classed('col-lg-6', true)
                            .on('click', function(d) {
                                
                                delete_column(graph, node, d)
                                render_columns(graph, node)

                                //refresh_window(graph)
                            })


                    //create create button
                    button_container
                        .append('div')
                            .classed('create-button', true)
                            .classed('delete-button', true)
                            .classed('col-lg-6', true)
                            .style('background-color', 'yellow')
                            .on('click', function(d) {
                                //create, needs access to graph
                                create_new_column(graph, node)
                                render_columns(graph, node)
                            })
                    
                })

        //update



        column_rows
            .each(function(column) {
              

                var main_container = d3.select(this).select('.main_container');

                var obj_arr;
                if (column.type == 'direct') {
                    obj_arr = [{
                        id: 'column_type_name',
                        value: column.type,
                        column_def: column,
                        field: 'type',
                        field_data: ['direct', 'count', 'sum', 'max'],
                        container_type: 'input_dropdown',
                        yes: 'a',
                        update: function(new_value) {
                            if (new_value == 'direct') {
                                //console.log(new_value, this.column_def);
                                this.column_def.type = new_value;
                            } else {
                                
                                
                                this.column_def.type = 'aggregate';
                                this.column_def.aggregation_function = new_value;
                                
                            }
                            
                        },
                        create_view: function(div) {
                        

                                //create
                                div
                                .append('button') // type div dropdown seeable part
                                    .attr('type', 'button')
                                    .classed('btn btn-default dropdown-toggle', true)
                                    .classed('column_type_name', true)
                                    .attr('data-toggle', 'dropdown')

                                var list = div
                                .append('ul') // drop down table
                                .classed('dropdown-menu pull-right', true)

                                list.selectAll('.li')
                                .data(_.map(div.datum().field_data, function(field_data) {
                                    return {
                                        value: field_data,
                                        data: div.datum()
                                    }
                                }))
                                .enter()
                                    .append('li')
                                        .append('a')
                                        .text(function(d) {         
                                            return d.value;
                                        });
                        },
                        update_view: function(div) {
                            div.selectAll('.column_type_name') // type div dropdown seeable part
                                    .text(function(d) {
                                            // console.warn(d.column_def.type)
                                            if (d.column_def.type == 'direct') {
                                                return d.column_def.type;
                                            } else if (d.column_def.type == 'aggregate') {
                                                return d.column_def.type;
                                            }
                                            // return obj_element.value;
                                        })
                        }
                    },
                    {
                        id: 'sort_type_value',
                        value: column.sort,
                        column_def: column,
                        field: 'sort',
                        field_data: ['none', 'asc', 'desc'],
                        container_type: 'input_dropdown',
                        update: function(new_value) {
                            
                            this.column_def.sort = new_value;
                        },
                        create_view: function(div) {

                                

                                div
                                .append('button') // type div dropdown seeable part
                                    .attr('type', 'button')
                                    .classed('btn btn-default dropdown-toggle', true)
                                    .classed('sort_type_value', true)
                                    .attr('data-toggle', 'dropdown')


                                var list = div
                                .append('ul') // drop down table
                                .classed('dropdown-menu pull-right', true)

                                list.selectAll('.li')
                                .data(_.map(div.datum().field_data, function(field_data) {
                                    return {
                                        value: field_data,
                                        data: div.datum()
                                    }
                                }))
                                 .enter()
                                    .append('li')
                                        .append('a')
                                        .text(function(d) {
                                           
                                            return d.value;
                                        });
                        },  
                        update_view: function(div) {
                             div.selectAll('.sort_type_value') // type div dropdown seeable part
                                    .text(function(d) {
                                           
                                            return div.datum().value;
                                        })
                        }                        
                    },
                    {
                        id: 'column_lable_value',
                        value: column.column_label,
                        column_def: column,
                        field: 'lable',
                        update: function(new_value) {
                            this.column_def.column_label = new_value;
                        },
                        create_view: function(div) {
                             
                                

                            div.append('input') // type div dropdown seeable part
                                .attr('type', 'text')
                                .classed('form-control', true)
                                // .classed('btn btn-default dropdown-toggle', true)
                                .on('change', function(d) {
                                    //console.warn(this, d, this.value);
                                    d.update(this.value);
                                    render_columns(graph, node)
                                })
                                
                        },
                        update_view: function(div) {
                            div.select('input')
                                .attr('value', function(d) {
                                   
                                    return d.value;
                                })
                        }                           
                    },
                    {
                        id: 'property_value',
                        value: column.property_name,
                        column_def: column,
                        field: 'property',
                        update: function(new_value) {
                            
                            this.column_def.property_name = new_value;
                        },
                        create_view: function(div) {
                            
                               

                                div.append('input') // type div dropdown seeable part
                                    .attr('type', 'text')
                                    .classed('form-control', true)
                                     .on('change', function(d) {
                                    //console.warn(this, d, this.value);
                                    d.update(this.value);
                                    render_columns(graph, node)
                                })
                                    // .classed('btn btn-default dropdown-toggle', true)
                                    
                        },
                        update_view: function(div) {
                            div.select('input')
                                .attr('value', function(d) {
                                   
                                    return d.value;
                                })
                        }                         
                    }];                   
                } else {
                    obj_arr = [{
                        id: 'column_type_name',
                        value: column.type,
                        column_def: column,
                        field: 'type',
                        field_data: ['direct', 'count', 'sum', 'max'],
                        container_type: 'input_dropdown',
                        yes: 'a',
                        update: function(new_value) {
                            if (new_value == 'direct') {
                                //console.log(new_value, this.column_def);
                                this.column_def.type = new_value;
                            } else {
                               
                                this.column_def.type = 'aggregate';
                                this.column_def.aggregation_function = new_value;
                                // console.log(new_value, this.column_def);
                            }
                            
                        },
                        create_view: function(div) {

                                //div.classed('input-group-btn', true)
                                //var data = [obj_element];

                                //bind
                                // var bind = div.selectAll('.type')
                                // .data([obj_element])

                                //create
                                div
                                .append('button') // type div dropdown seeable part
                                    .attr('type', 'button')
                                    .classed('btn btn-default dropdown-toggle', true)
                                    .classed('column_type_name', true)
                                    .attr('data-toggle', 'dropdown')

                                var list = div
                                .append('ul') // drop down table
                                .classed('dropdown-menu pull-right', true)

                                list.selectAll('.li')
                                .data(_.map(div.datum().field_data, function(field_data) {
                                    return {
                                        value: field_data,
                                        data: div.datum()
                                    }
                                }))
                                .enter()
                                    .append('li')
                                        .append('a')
                                        .text(function(d) {
                                            //console.warn(d.data.column_def.aggregation_function);
                                            return d.value;
                                        });
                        },
                        update_view: function(div) {
                            div.selectAll('.column_type_name') // type div dropdown seeable part
                                    .text(function(d) {
                                            
                                            if (d.column_def.type == 'direct') {
                                                return d.column_def.type;
                                            } else if (d.column_def.type == 'aggregate') {
                                                return d.column_def.aggregation_function;
                                            }
                                            
                                        })
                        }
                    },
                    {
                        id: 'sort_type_value',
                        value: column.sort,
                        column_def: column,
                        field: 'sort',
                        field_data: ['none', 'asc', 'desc'],
                        container_type: 'input_dropdown',
                        update: function(new_value) {
                            
                            this.column_def.sort = new_value;
                        },
                        create_view: function(div) {

                           
                                // var bind = div.selectAll('.sort')
                                // .data([obj_element]);

                                div
                                .append('button') // type div dropdown seeable part
                                    .attr('type', 'button')
                                    .classed('btn btn-default dropdown-toggle', true)
                                    .classed('sort_type_value', true)
                                    .attr('data-toggle', 'dropdown')


                                var list = div
                                .append('ul') // drop down table
                                .classed('dropdown-menu pull-right', true)

                                list.selectAll('.li')
                                .data(_.map(div.datum().field_data, function(field_data) {
                                    return {
                                        value: field_data,
                                        data: div.datum()
                                    }
                                }))
                                 .enter()
                                    .append('li')
                                        .append('a')
                                        .text(function(d) {
                                            //console.log(d)
                                            return d.value;
                                        });
                        },
                        update_view: function(div) {
                             div.selectAll('.sort_type_value') // type div dropdown seeable part
                                    .text(function(d) {
                                            // console.log(d, obj_element)
                                            return div.datum().value;
                                        })
                        }                         
                    },
                    {
                        id: 'column_lable_value',
                        value: column.column_label,
                        column_def: column,
                        field: 'lable',
                        update: function(new_value) {
                            this.column_def.column_label = new_value;
                        },
                        create_view: function(div) {
                            
                                
                                div.append('input') // type div dropdown seeable part
                                    .attr('type', 'text')
                                    .classed('form-control', true)
                                    // .classed('btn btn-default dropdown-toggle', true)
                                    .attr('data-toggle', 'dropdown')
                                    .on('change', function(d) {
                                        console.warn('input change');
                                        d.update(this.value);
                                        render_columns(graph, node)
                                    })

                        },
                        update_view: function(div) {
                            div.select('input')
                            .attr('value', function(d) {
                                            
                                            return d.value;
                                        })
                        }                        
                    },
                    {
                        id: 'what_to_aggregate',
                        value: column.what_to_aggregate,
                        column_def: column,
                        field: 'what_to_aggregate',
                        update: function(new_value) {
                            // this.data.what_to_aggregat = new_value;
                        },
                        create_view: function(div) {
                            div.append('input') // type div dropdown seeable part
                                    .attr('type', 'text')
                                    .classed('form-control', true)
                                    // .classed('btn btn-default dropdown-toggle', true)
                                    .classed('what_to_aggregate', true)
                                    .attr('data-toggle', 'dropdown')
                                    .attr('value', function(d) {
                                            
                                            return d.value; // maybe need to pasre this 
                                        })
                        },
                        update_view: function(div) {
                            div.selectAll('.what_to_aggregate')
                            .attr('value', function(d) {
                                return d.value; // maybe need to pasre this 
                            })
                        }                         
                    }]; 
                }


                //bind?
                var sub_containers = main_container.selectAll('div')
                    .data(obj_arr, function(obj) {
                        return obj.id;
                    });


                //create subdivs
                sub_containers
                    .enter()
                        .append('div')
                        .each(function(obj_element) {
                            //console.log(obj_element, this);
                            var div = d3.select(this);

                            var input_div = div.attr('class', obj_element.field)
                                .classed('col-lg-3', true)
                                .append('div')  // subdiv
                                    .classed('input-group', true)
                                    .classed('div_element.id', true);

                            
                                
                                //update 
                                obj_element.create_view(div, obj_element);

                                //remove
                                console.log(obj_element)
                        })


                // update
                sub_containers
                    .each(function(obj_element) {
                        //create? XD
                        var div = d3.select(this);

                        
                        obj_element.update_view(div, obj_element);

                        if(obj_element.id == 'column_type_name') {
                                //div.classed('input-group-btn', true)
                                //var data = [obj_element];

                              
                                //update 


                                //remove

                        } else if (obj_element.id ==  'sort_type_value') {
                           
                        } else if(  obj_element.id == 'aggregate_function_value') {

                            
                        }
                        
                    })

                //exit
                sub_containers.exit().remove();

                console.log('end')
            })



        //remove
        column_rows.exit().remove();



    }


    $( document.body ).on( 'click', '.dropdown-menu li', function( event ) {
    
        var li = d3.select(event.currentTarget);
        console.log(li.node(),li.datum().data,  li.datum().data.update(li.datum().value)) // somehow this does not work


        render_columns(example_graph, example_graph['t1']);
        
       
     
    });


    function create_new_column(graph, node) {
        var column = {
            // data property
            'id' : guid(), // ????
            'type' : 'direct',
            'column_label' : 'label1',
            'property_name' : 'rdfs:label',
            'sort': 'none' 
        }
        graph[node.name].columns.push(column);
        
    }

    function delete_column(graph, node, column) { // could be problems with indexes
        var delete_index = _.chain(graph[node.name].columns)
            .pluck('id')
            .indexOf(column.id)
            .value();

        delete graph[node.name].columns[delete_index];
        graph[node.name].columns = _.compact(graph[node.name].columns);
        
    }

    function refresh_window(graph) {
        //refresh
    }

    function guid() { // taken from http://stackoverflow.com/a/2117523
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
           var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
           return v.toString(16);
        });
    }

    render_columns(example_graph, example_graph['t1']);

    render_columns(example_graph, example_graph['t1']);


                                    




    </script>
    </body>
</html>